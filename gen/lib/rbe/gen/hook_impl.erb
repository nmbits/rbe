% f, c = args
% arg_types = f.args.map do |a|
%   a.out ? "Out<#{a.type}>" : "In<#{a.type}>"
% end.join(", ")
% args_def = f.args.each_with_index.map{|a, i| "#{a.type} arg#{i}" }.join(", ")

% if f.arity == 0
<%= f.ret %>
<%= f.name %>(<%= c.api_name %> *_this)
% else
<%= f.ret %>
<%= f.name %>(<%= c.api_name %> *_this, <%= args_def %>)
% end
{
	RBE_TRACE("Hook::<%= c.name %>::<%= f.name %>");
	if (FuncallState() != 0)
% if f.ret?
		return <%= f.ret_default %>;
% else
		return;
% end

% ftype = "Funcall<#{f.ret} (#{c.api_name}::*)(#{arg_types})>"
% f.args.each_with_index do |a, i|
	<%= a.out ? "Out<#{a.type}>" : "In<#{a.type}>" %> a<%= i %>(arg<%= i %>);
% end
% if f.arity == 0
	<%= ftype %> f(_this, "<%= ruby_name f.name %>");
% else
	<%= ftype %> f(_this, "<%= ruby_name f.name %>", <%= f.arity.times.map{|i| "a#{i}" }.join(", ") %>);
% end
	Protect<<%= ftype %> > p(f);
	CallWithGVL<Protect<<%= ftype %> > > g(p);
	g();
	SetFuncallState(p.State());
% if f.ret?
	if (p.State() != 0) {
		return <%= f.ret_default %>;
	}
% end
% if f.ret?
	return f.Result();
% end
}
